# GitHub Actions Workflow - Contribution Snake Animation Generator
# Author: David St. John (davestj@gmail.com)
# Date: December 2024
# File: .github/workflows/snake.yml
# Repository: davestj/davestj (GitHub Profile Repository)
# Purpose: I use this workflow to generate an animated SVG snake that visualizes my GitHub contributions
# 
# Change Log:
# - v1.0.0 (2024-12): Initial workflow implementation - I created this to automate snake generation
# - v1.1.0 (2024-12): Fixed permissions issue - I added explicit write permissions for the workflow
# - Added permissions block to grant content and actions write access
# - Simplified the commit strategy to use built-in git commands
# - Added better error handling and diagnostic output
#
# Technical Notes:
# - I explicitly grant write permissions to avoid the 403 error
# - I use the Platane/snk@v3 action for reliable snake generation
# - I generate both light and dark theme versions for accessibility
# - I commit directly to the output branch using proper authentication

name: Generate GitHub Contribution Snake

# I grant permissions explicitly to allow pushing to the repository
# This is critical - without these permissions, the workflow will fail with a 403 error
permissions:
  contents: write  # I need this to push the generated files
  actions: write   # I need this to update workflow status
  pages: write     # I need this for GitHub Pages if I decide to use it
  id-token: write  # I need this for advanced GitHub features

# I configure when this workflow runs
on:
  # I schedule this to run automatically every day at midnight UTC
  # This ensures my contribution snake is always up-to-date
  schedule:
    - cron: "0 0 * * *"
  
  # I allow manual triggering from the Actions tab
  # This is useful when I want to regenerate immediately after contributions
  workflow_dispatch:
  
  # I trigger on pushes to main to keep the snake current
  # This helps when I update my profile README
  push:
    branches:
      - main
      - master

# I set up the jobs that will run
jobs:
  generate-snake:
    # I name this job descriptively for the Actions UI
    name: Generate contribution snake animation
    
    # I use the latest Ubuntu runner for optimal performance
    runs-on: ubuntu-latest
    
    # I set a timeout to prevent hanging jobs
    timeout-minutes: 10
    
    # I define the steps to generate the snake
    steps:
      # Step 1: I check out my repository with proper token
      # This gives the workflow write access to my repo
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # I use the GitHub token for authentication
          token: ${{ secrets.GITHUB_TOKEN }}
          # I need the full history for accurate contribution data
          fetch-depth: 0
      
      # Step 2: I generate the snake animation files
      # This is the core step that creates the SVG animations
      - name: Generate snake animation
        uses: Platane/snk@v3
        id: snake-gif
        with:
          # I use my GitHub username for the contribution data
          github_user_name: ${{ github.repository_owner }}
          
          # I configure the outputs - creating both light and dark themes
          # These will be saved as separate SVG files
          outputs: |
            dist/github-contribution-grid-snake.svg
            dist/github-contribution-grid-snake-dark.svg?palette=github-dark
            dist/github-contribution-grid-snake.gif
          
        env:
          # I provide the GitHub token for API authentication
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      # Step 3: I verify the generated files exist
      # This helps me ensure the generation was successful
      - name: Verify generated files
        run: |
          echo "I'm checking if the snake files were generated successfully..."
          if [ -d "dist" ]; then
            echo "✅ I found the dist directory"
            echo "I generated the following files:"
            ls -la dist/
            echo ""
            echo "File sizes:"
            du -h dist/*
          else
            echo "❌ The dist directory wasn't created"
            exit 1
          fi
      
      # Step 4: I set up git configuration for committing
      # This ensures git knows who is making the commits
      - name: Setup git configuration
        run: |
          # I configure git with the GitHub Actions bot identity
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # I verify my configuration
          echo "Git configuration:"
          git config --get user.name
          git config --get user.email
      
      # Step 5: I deploy the snake to the output branch
      # This is the main deployment step that pushes the files
      - name: Deploy to output branch
        run: |
          # I fetch all branches to ensure I have the latest state
          git fetch origin
          
          # I check if the output branch exists
          if git show-ref --verify --quiet refs/remotes/origin/output; then
            echo "I found an existing output branch, checking it out..."
            git checkout output
            git pull origin output
          else
            echo "I'm creating a new output branch..."
            git checkout --orphan output
            # I remove all files from the staging area for a clean branch
            git rm -rf . || true
          fi
          
          # I ensure the dist directory exists and has content
          if [ ! -d "dist" ]; then
            echo "Creating dist directory from workspace..."
            mkdir -p dist
            # I copy files from the workspace if they exist elsewhere
            cp -r ${{ github.workspace }}/dist/* dist/ 2>/dev/null || true
          fi
          
          # I copy the generated files to the root for easier access
          if [ -f "dist/github-contribution-grid-snake.svg" ]; then
            cp dist/github-contribution-grid-snake.svg .
            cp dist/github-contribution-grid-snake-dark.svg .
            [ -f "dist/github-contribution-grid-snake.gif" ] && cp dist/github-contribution-grid-snake.gif .
            
            # I add all the snake files
            git add *.svg *.gif 2>/dev/null || true
            git add dist/ 2>/dev/null || true
            
            # I create a commit with a descriptive message
            COMMIT_MESSAGE="🐍 Update contribution snake - $(date +'%Y-%m-%d %H:%M:%S UTC')"
            git commit -m "$COMMIT_MESSAGE" || echo "No changes to commit"
            
            # I push to the output branch
            echo "I'm pushing the snake animation to the output branch..."
            git push origin output --force-with-lease || git push origin output --force
            
            echo "✅ Successfully deployed snake animation to output branch!"
            echo "📊 Files are now available at:"
            echo "   Light: https://raw.githubusercontent.com/${{ github.repository }}/output/github-contribution-grid-snake.svg"
            echo "   Dark:  https://raw.githubusercontent.com/${{ github.repository }}/output/github-contribution-grid-snake-dark.svg"
          else
            echo "❌ Snake files were not generated properly"
            exit 1
          fi
      
      # Step 6: I create a summary for the Actions UI
      # This provides a nice overview in the workflow run summary
      - name: Create job summary
        if: always()
        run: |
          echo "# 🐍 Snake Generation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "dist/github-contribution-grid-snake.svg" ]; then
            echo "✅ **Status:** Successfully generated snake animation" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## 📁 Generated Files:" >> $GITHUB_STEP_SUMMARY
            echo "- \`github-contribution-grid-snake.svg\` (Light theme)" >> $GITHUB_STEP_SUMMARY
            echo "- \`github-contribution-grid-snake-dark.svg\` (Dark theme)" >> $GITHUB_STEP_SUMMARY
            [ -f "dist/github-contribution-grid-snake.gif" ] && echo "- \`github-contribution-grid-snake.gif\` (Animated GIF)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## 🔗 Access URLs:" >> $GITHUB_STEP_SUMMARY
            echo "- [Light Theme](https://raw.githubusercontent.com/${{ github.repository }}/output/github-contribution-grid-snake.svg)" >> $GITHUB_STEP_SUMMARY
            echo "- [Dark Theme](https://raw.githubusercontent.com/${{ github.repository }}/output/github-contribution-grid-snake-dark.svg)" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Status:** Failed to generate snake animation" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please check the workflow logs for details." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Generated by GitHub Actions at $(date +'%Y-%m-%d %H:%M:%S UTC')*" >> $GITHUB_STEP_SUMMARY

# Workflow Documentation
# =====================
# 
# Required Repository Settings:
# 1. Go to Settings > Actions > General
# 2. Under "Workflow permissions", select "Read and write permissions"
# 3. Check "Allow GitHub Actions to create and approve pull requests" (optional but recommended)
# 4. Click "Save"
#
# Alternative: Using a Personal Access Token (PAT)
# If the above doesn't work, you can use a PAT:
# 1. Go to Settings > Developer settings > Personal access tokens > Tokens (classic)
# 2. Generate a new token with 'repo' scope
# 3. Add it as a secret named GH_PAT in your repository (Settings > Secrets > Actions)
# 4. Replace ${{ secrets.GITHUB_TOKEN }} with ${{ secrets.GH_PAT }} in this workflow
#
# How I Use This Workflow:
# 1. This workflow runs automatically every day at midnight UTC
# 2. I can also trigger it manually from the Actions tab when needed
# 3. It generates SVG files for both light and dark themes
# 4. The files are pushed to an 'output' branch to keep main branch clean
# 5. My README references these files using the raw GitHub URLs
#
# Troubleshooting:
# - Permission denied: Check Settings > Actions > General > Workflow permissions
# - Snake not appearing: Verify the output branch exists and has the files
# - Generation fails: Check if your contribution graph is visible publicly
# - API rate limits: Wait an hour and try again, or use a PAT for higher limits
#
# URLs for README.md:
# After successful deployment, use these URLs in your README:
# ![](https://raw.githubusercontent.com/davestj/davestj/output/github-contribution-grid-snake-dark.svg)
